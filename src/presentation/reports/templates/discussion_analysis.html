<!DOCTYPE html>
<html>
<head>
    <title>Discussion Analysis Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
            background: #f9f9f9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        .timeline, .hierarchy, .speaker-stats {
            margin: 2em 0;
            padding: 1em;
            background: white;
            border-radius: 8px;
            overflow-x: auto; /* Allow scrolling for timeline if needed */
        }
        .topic {
            padding: 1em;
            margin: 0.5em 0;
            background: #f5f5f5;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }
        .timeline-label {
            font-size: 12px;
        }
        .timeline-bar {
            fill: #2196F3;
            opacity: 0.8;
        }
        .timeline-bar:hover {
            opacity: 1;
        }
        .tooltip {
            position: absolute;
            padding: 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
        }
        h1 { color: #1976D2; }
        h2 {
            color: #2196F3;
            border-bottom: 2px solid #E3F2FD;
            padding-bottom: 0.5em;
        }
        #timeline-viz {
            min-height: 200px;
        }
        #timeline-viz svg {
            display: block;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Discussion Analysis Report</h1>
        <div class="metadata">
            <p>Generated: {{ timestamp }}</p>
        </div>

        <div class="timeline">
            <h2>Topic Timeline</h2>
            <div id="timeline-viz"></div>
        </div>

        <div class="hierarchy">
            <h2>Topic Hierarchy</h2>
            <div id="hierarchy-viz"></div>
        </div>

        <div class="topics">
            <h2>Topics Discussed</h2>
            {% for topic in data.topics %}
            <div class="topic">
                <h3>{{ topic.name }}</h3>
                <p>Importance: {{ topic.importance_score }}</p>
                <p>Duration: {{ topic.start_time|round(2) }} - {{ topic.end_time|round(2) }}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        // Timeline visualization
        const timelineData = JSON.parse('{{ viz_data.timeline | tojson | safe }}');

        // Calculate dimensions based on container width
        const container = document.getElementById('timeline-viz');
        const containerWidth = container.clientWidth;

        // Set up timeline dimensions with responsive width
        const margin = {top: 40, right: 40, bottom: 60, left: 180};
        const width = containerWidth - margin.left - margin.right;
        const height = Math.max(timelineData.labels.length * 50, 200); // Minimum height of 200px

        // Create SVG container with responsive sizing
        const svg = d3.select("#timeline-viz")
            .append("svg")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .attr("preserveAspectRatio", "xMidYMid meet")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create scales
        const xScale = d3.scaleLinear()
            .domain([0, d3.max(timelineData.end)])
            .range([0, width]);

        const yScale = d3.scaleBand()
            .domain(timelineData.labels)
            .range([0, height])
            .padding(0.2);

        // Create axes
        const xAxis = d3.axisBottom(xScale)
            .tickFormat(d => d + "s");
        const yAxis = d3.axisLeft(yScale);

        // Add axes to SVG
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis)
            .append("text")
            .attr("x", width/2)
            .attr("y", 40)
            .attr("fill", "black")
            .text("Time (seconds)");

        svg.append("g")
            .call(yAxis);

        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Add bars
        svg.selectAll("rect")
            .data(timelineData.labels)
            .enter()
            .append("rect")
            .attr("class", "timeline-bar")
            .attr("y", d => yScale(d))
            .attr("x", (d, i) => xScale(timelineData.start[i]))
            .attr("width", (d, i) => xScale(timelineData.end[i]) - xScale(timelineData.start[i]))
            .attr("height", yScale.bandwidth())
            .on("mouseover", function(event, d, i) {
                const idx = timelineData.labels.indexOf(d);
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`Topic: ${d}<br/>
                            Start: ${timelineData.start[idx].toFixed(2)}s<br/>
                            End: ${timelineData.end[idx].toFixed(2)}s`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });

        // Make the visualization responsive
        window.addEventListener('resize', function() {
            const newWidth = container.clientWidth;
            svg.attr("viewBox", `0 0 ${newWidth} ${height + margin.top + margin.bottom}`);
        });

        // Sentiment data from backend
        const sentimentData = JSON.parse('{{ viz_data.sentiment | tojson | safe }}');

        // Create sentiment gauge
        const gauge = d3.select("#sentiment-gauge")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", "0 0 200 100");

        // Create sentiment timeline
        const sentimentViz = d3.select("#sentiment-viz")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%");

        // Create line generator for sentiment timeline
        const line = d3.line()
            .x(d => xScale(d.timestamp))
            .y(d => yScale(d.sentiment_score));

        // Add sentiment timeline path
        sentimentViz.append("path")
            .datum(sentimentData.timeline)
            .attr("class", "sentiment-line")
            .attr("d", line)
            .style("fill", "none")
            .style("stroke", "#2196F3")
            .style("stroke-width", 2);

        // Create speaker sentiment bars
        const speakerSentiment = d3.select("#speaker-sentiment-viz")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%");

        // Add bars for each speaker's sentiment
        speakerSentiment.selectAll("rect")
            .data(Object.entries(sentimentData.speaker_sentiments))
            .enter()
            .append("rect")
            .attr("x", (d, i) => i * barWidth)
            .attr("y", d => Math.max(0, yScale(d[1])))
            .attr("width", barWidth - 2)
            .attr("height", d => Math.abs(yScale(d[1]) - yScale(0)))
            .style("fill", d => d[1] > 0 ? "#4CAF50" : "#F44336");
    </script>
</body>
</html>